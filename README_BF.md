
# Cloudflare Pages 全栈应用部署黄金法则 (NEXUS 架构备忘录)

> **文档用途**：此文档记录了 React (Frontend) + Cloudflare Worker (Backend) 全栈应用在 Cloudflare Pages 上的最佳部署实践。下次开发类似项目时，请参考此架构。

---

## 1. 核心原理：如何“激活”后端？

Cloudflare Pages 默认仅托管静态资源 (HTML/CSS/JS)。要使其具备后端 API 能力（处理 KV/R2/Auth），必须触发 **Advanced Mode (高级模式)**。

**触发条件**：
构建输出目录（通常是 `dist`）的根目录下，必须存在一个名为 `_worker.js` 的文件。

---

## 2. 关键文件配置 (四大金刚)

### A. `package.json` (注入灵魂)
**作用**：在构建时自动将后端代码注入到前端构建产物中。
**关键代码**：
```json
{
  "scripts": {
    "dev": "vite",
    // 核心魔法：构建前端 -> 复制 worker.js -> 重命名为 _worker.js -> 放入 dist
    "build": "vite build && node -e \"require('fs').copyFileSync('worker.js', 'dist/_worker.js')\"",
    // 一键部署命令
    "deploy": "npm run build && wrangler deploy"
  },
  "dependencies": {
    // 遇到 SDK 版本找不到时，使用 "*" 获取最新版
    "@google/genai": "*"
  }
}
```

### B. `wrangler.json` (连接器)
**作用**：定义资源绑定，解决白屏问题。
**注意**：**千万不要**在这里写 `vars` (环境变量)，否则会覆盖 Cloudflare 后台设置，导致改密码无效。
**关键配置**：
```json
{
  "name": "nexus-audio",
  "main": "worker.js",
  "compatibility_date": "2024-09-23",
  "assets": {
    "directory": "./dist",  // 必须指向构建输出目录，解决白屏
    "binding": "ASSETS"     // 让 Worker 能接管静态资源
  },
  "kv_namespaces": [ ... ], // 在此绑定数据库
  "r2_buckets": [ ... ]     // 在此绑定存储桶
}
```

### C. `worker.js` (路由守门员)
**作用**：处理 API 请求，并兼容 SPA 前端路由。
**标准模版**：
```javascript
export default {
  async fetch(request, env, ctx) {
    const url = new URL(request.url);

    // 1. API 请求拦截 (后端逻辑)
    if (url.pathname.startsWith('/api/')) {
        // ... 处理鉴权、数据库操作 ...
        return new Response(...)
    }

    // 2. 静态资源兜底 (前端页面)
    try {
        let response = await env.ASSETS.fetch(request);
        
        // 3. SPA 路由修复 (解决刷新 404)
        // 如果资源不存在(404)且不是API，返回 index.html
        if (response.status === 404) {
            return await env.ASSETS.fetch(new Request(new URL('/index.html', request.url), request));
        }
        return response;
    } catch (e) {
        return new Response("Error", { status: 500 });
    }
  }
}
```

### D. `vite.config.ts` (构建输出)
**作用**：确保输出目录名为 `dist`，与 wrangler 配置一致。
**关键代码**：
```typescript
export default defineConfig({
  build: {
    outDir: 'dist',
    emptyOutDir: true,
  }
});
```

---

## 3. 常见问题与避坑 (Troubleshooting)

| 现象 | 原因 | 解决方案 |
| :--- | :--- | :--- |
| **405 Method Not Allowed** | Worker 未启动，请求打到了静态服务器。 | 检查 `package.json` 的 build 命令，确保 `_worker.js` 被成功复制到了 `dist` 目录。 |
| **白屏 / 404** | 静态资源路径不对，或 SPA 路由未处理。 | 1. 确保 `index.html` 引入了 `index.tsx`。<br>2. 确保 `worker.js` 处理了 404 回退逻辑。 |
| **后台改密码不生效** | 本地配置覆盖了云端配置。 | **删除** `wrangler.json` 中的 `vars` 字段。只在 Cloudflare Dashboard 设置变量。 |
| **Error: Too many redirects** | Worker 强制重定向 `/` 到 `index.html`。 | Cloudflare 会自动处理 Pretty URL，**不要**在 worker 中手动重写根路径。 |
| **npm error notarget** | 依赖包版本号过旧或不存在。 | 在 `package.json` 中将版本号改为 `"*"`。 |

---

## 4. 部署检查清单 (Checklist)

1.  [ ] **Cloudflare 后台**：创建 KV Namespace 和 R2 Bucket。
2.  [ ] **Cloudflare 变量**：在 Settings -> Variables 设置 `ADMIN_PASSWORD` 等机密。
3.  [ ] **本地代码**：确认 `package.json` 包含复制脚本。
4.  [ ] **执行部署**：
    ```bash
    npm install
    npm run deploy  # 自动执行 build + copy + wrangler deploy
    ```

---

*Generated by NEXUS Studio Architecture Assistant*